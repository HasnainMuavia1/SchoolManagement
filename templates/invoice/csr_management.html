{% extends 'invoice/base_admin.html' %}
{% load static %}

{% block title %}CSR Management{% endblock %}

{% block extra_css %}
<style>
    /* Override any default styles */
    .card-body .add-csr-btn {
        display: inline-block !important;
        background-color: #e9ecef !important;
        color: #000000 !important;
        border: 2px solid #000000 !important;
        padding: 8px 16px !important;
        font-weight: 500 !important;
        text-decoration: none !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        opacity: 1 !important;
        visibility: visible !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }
    
    .card-body .add-csr-btn:hover {
        background-color: #000000 !important;
        color: #ffffff !important;
        border-color: #000000 !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
    }

    .card-body .add-csr-btn i {
        color: inherit !important;
        margin-right: 8px !important;
    }

    /* Ensure the card has a white background */
    .card {
        background-color: #ffffff !important;
        border: 1px solid #dee2e6 !important;
    }

    /* Ensure text colors in the card body are visible */
    .card-body {
        color: #000000 !important;
    }

    /* Table styling */
    .table {
        margin-bottom: 0;
    }
    
    .table th {
        font-weight: 500;
        color: black;
        border-bottom: 1px solid #e0e0e0;
        padding: 12px 15px;
        white-space: nowrap;
    }
    
    .table td {
        padding: 12px 15px;
        vertical-align: middle;
        border-bottom: 1px solid #e0e0e0;
    }

    /* Badge styling */
    .badge {
        font-weight: normal;
        padding: 5px 10px;
    }

    /* Button styling */
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .btn-outline-dark:hover {
        background-color: #343a40;
        color: white;
    }

    .btn-outline-danger:hover {
        background-color: #dc3545;
        color: white;
    }
</style>
{% endblock %}

{% block page_title %}CSR Management{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <!-- Search and Add Button Row -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-white">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="csrSearch" class="form-control" placeholder="Search CSRs...">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#addCSRModal">
                    <i class="fas fa-plus me-1"></i> Add New CSR
                </button>
            </div>
        </div>
        
        <!-- CSR Table -->
        <div class="table-responsive">
            <table class="table" id="csrTable">
                <thead>
                    <tr>
                        <th>CSR</th>
                        <th>Username</th>
                        <th>Status</th>
                        <th>Lead Role</th>
                        <th>Invoices</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for csr in csrs %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="me-2" style="color: black;">{{ csr.full_name }}</span>
                            </div>
                        </td>
                        <td style="color: black;">{{ csr.user.username }}</td>
                        <td style="color: black;">
                            {% if csr.is_active %}Active{% else %}Inactive{% endif %}
                        </td>
                        <td style="color: black;">
                            {% if csr.lead_role %}Lead{% else %}Regular{% endif %}
                        </td>
                        <td style="color: black;">{{ csr.invoice_count }}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-dark edit-csr" 
                                        data-id="{{ csr.id }}"
                                        data-name="{{ csr.full_name }}"
                                        data-username="{{ csr.user.username }}"
                                        data-active="{{ csr.is_active|yesno:'true,false' }}"
                                        data-lead="{{ csr.lead_role|yesno:'true,false' }}"
                                        data-bs-toggle="tooltip" 
                                        title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger delete-csr" 
                                        data-id="{{ csr.id }}"
                                        data-bs-toggle="tooltip" 
                                        title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fas fa-users fa-3x mb-3 text-secondary"></i>
                                <h5>No CSRs Found</h5>
                                <p class="text-muted">Add your first CSR to get started</p>
                                <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#addCSRModal">
                                    <i class="fas fa-plus me-1"></i> Add New CSR
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add CSR Modal -->
<div class="modal fade" id="addCSRModal" tabindex="-1" aria-labelledby="addCSRModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCSRModalLabel">Add New CSR</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="addCSRForm" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="add">
                <input type="hidden" name="role" value="csr">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="fullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="fullName" name="full_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="isActive" name="is_active" checked>
                            <label class="form-check-label" for="isActive">Active</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="leadRole" name="lead_role">
                            <label class="form-check-label" for="leadRole">Lead Role</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 1rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background-color: #6c757d; color: white; padding: 0.5rem 1rem; border-radius: 4px;">Close</button>
                    <button type="submit" class="btn btn-primary" style="background-color: #000; color: white; padding: 0.5rem 1rem; border-radius: 4px;">Add CSR</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit CSR Modal -->
<div class="modal fade" id="editCSRModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit CSR</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="csr_id" id="editCSRId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editFullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="editFullName" name="full_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="editPassword" name="password">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editIsActive" name="is_active">
                        <label class="form-check-label" for="editIsActive">Active</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editLeadRole" name="lead_role">
                        <label class="form-check-label" for="editLeadRole">Lead Role</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete CSR Modal -->
<div class="modal fade" id="deleteCSRModal" tabindex="-1" aria-labelledby="deleteCSRModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: white;">
            <div class="modal-header" style="background-color: white;">
                <h5 class="modal-title" id="deleteCSRModalLabel">Delete CSR</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="deleteCSRForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="csr_id" id="deleteCsrId">
                    
                    <p>Are you sure you want to delete <strong id="deleteCsrName"></strong>?</p>
                    <p class="text-danger">This action cannot be undone.</p>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="deleteCSRForm" class="btn btn-danger">
                    <i class="fas fa-trash me-1"></i> Delete CSR
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the modal
        const addCSRModal = new bootstrap.Modal(document.getElementById('addCSRModal'));
        
        // Function to open the modal
        window.openAddCSRModal = function() {
            addCSRModal.show();
        };
        
        // Toggle password visibility
        const togglePasswordButtons = document.querySelectorAll('.toggle-password');
        
        togglePasswordButtons.forEach(button => {
            button.addEventListener('click', function() {
                const input = this.previousElementSibling;
                const icon = this.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        });
        
        // Form validation
        const addCSRForm = document.getElementById('addCSRForm');
        
        if (addCSRForm) {
            addCSRForm.addEventListener('submit', function(event) {
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (password !== confirmPassword) {
                    event.preventDefault();
                    alert('Passwords do not match!');
                }
            });
        }
        
        // Handle Edit CSR button clicks
        const editButtons = document.querySelectorAll('.edit-csr');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const csrId = this.getAttribute('data-id');
                const csrName = this.getAttribute('data-name');
                const csrUsername = this.getAttribute('data-username');
                const csrActive = this.getAttribute('data-active');
                const csrLead = this.getAttribute('data-lead');
                
                document.getElementById('editCSRId').value = csrId;
                document.getElementById('editFullName').value = csrName;
                document.getElementById('editUsername').value = csrUsername;
                document.getElementById('editIsActive').checked = csrActive === 'True';
                document.getElementById('editLeadRole').checked = csrLead === 'True';
            });
        });
        
        // Handle Delete CSR button clicks
        const deleteButtons = document.querySelectorAll('.delete-csr');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const csrId = this.getAttribute('data-id');
                const csrName = this.getAttribute('data-name');
                
                document.getElementById('deleteCsrId').value = csrId;
                document.getElementById('deleteCsrName').textContent = csrName;
            });
        });
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Search functionality
        const csrSearch = document.getElementById('csrSearch');
        if (csrSearch) {
            csrSearch.addEventListener('keyup', function() {
                const searchValue = this.value.toLowerCase();
                const table = document.getElementById('csrTable');
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    if (row.cells.length > 1) { // Skip empty state row
                        // Get the CSR name - need to find the span inside first cell
                        const nameSpan = row.querySelector('td:first-child .d-flex span');
                        const name = nameSpan ? nameSpan.textContent.toLowerCase() : '';
                        
                        // Get the username from the second cell
                        const username = row.cells[1] ? row.cells[1].textContent.toLowerCase() : '';
                        
                        if (name.includes(searchValue) || username.includes(searchValue)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
            });
        }
    });
</script>
<script src="{% static 'js/csr_management.js' %}"></script>
{% endblock %}
